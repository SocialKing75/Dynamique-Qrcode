<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QRGen — Générateur de QR</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <main class="container">
    <h1>QRGen</h1>
    <p class="lead">Générez un QR code et partagez le lien.</p>

    <form id="qr-form" class="card">
      <h2>Générateur simple</h2>
      <label>Titre (optionnel)
        <input type="text" name="title" placeholder="Mon lien" />
      </label>
      <label>URL / Contenu
        <input type="url" name="content" placeholder="https://example.com" required />
      </label>
      <label class="row">
        <input type="checkbox" name="is_dynamic" /> <span>Dynamic (modifiable après création)</span>
      </label>

      <div class="actions">
        <button type="submit" class="btn">Générer</button>
      </div>
    </form>

    <div class="card" id="dropbox-integration">
      <h2>Intégration PDF Dropbox</h2>
      <p>Entrez le nom du fichier PDF déjà présent dans votre dossier Dropbox.</p>
      <form id="automation-form">
        <label>Nom du fichier PDF
          <input type="text" id="pdf-filename" placeholder="mon-document.pdf" required />
        </label>
        <div class="actions">
          <button type="submit" id="btn-automation" class="btn secondary">Générer et insérer QR code</button>
        </div>
      </form>
      <div id="automation-status" class="hidden status-msg"></div>
    </div>

    <section id="result" class="card hidden">
      <h2>QR code créé</h2>
      <p>Slug: <code id="slug"></code></p>
      <p>Redirection: <a id="redir" target="_blank"></a></p>
      <p>Image: <img id="img" alt="QR image" /></p>
      <div class="actions">
        <a id="img-link" class="btn" target="_blank">Ouvrir l'image</a>
      </div>
    </section>

    <footer>
      <small>Backend API: <code>/api/qrcodes</code> — Redirection: <code>/q/{slug}</code> — <a href="/admin">Admin</a></small>
    </footer>
  </main>

  <style>
    .secondary { background-color: #4A90E2; }
    .status-msg { margin-top: 1rem; padding: 0.5rem; border-radius: 4px; background: #f0f0f0; }
    .hidden { display: none; }
  </style>

  <script>
  // Simple QR generation
  const form = document.getElementById('qr-form');
  const result = document.getElementById('result');
  const slugEl = document.getElementById('slug');
  const redirEl = document.getElementById('redir');
  const imgEl = document.getElementById('img');
  const imgLink = document.getElementById('img-link');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const payload = {
      title: formData.get('title') || undefined,
      content: formData.get('content'),
      is_dynamic: formData.get('is_dynamic') === 'on'
    };
    try {
      const res = await fetch('/api/qrcodes/', {
        method: 'POST', headers: {'content-type':'application/json'}, body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error('Erreur à la création');
      const data = await res.json();
      const slug = data.slug;
      slugEl.textContent = slug;
      redirEl.textContent = window.location.origin + '/q/' + slug;
      redirEl.href = '/q/' + slug;
      imgEl.src = `/api/qrcodes/${data.id}/image?size=300`;
      imgLink.href = imgEl.src;
      result.classList.remove('hidden');
      result.scrollIntoView({behavior:'smooth'});
    } catch (err) {
      alert(err.message || 'Erreur');
    }
  });

  // Dropbox Automation
  const automationForm = document.getElementById('automation-form');
  const btnAutomation = document.getElementById('btn-automation');
  const statusEl = document.getElementById('automation-status');

  automationForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const filename = document.getElementById('pdf-filename').value;
    
    btnAutomation.disabled = true;
    btnAutomation.textContent = "Traitement en cours...";
    statusEl.textContent = "Recherche et modification du PDF...";
    statusEl.classList.remove('hidden');

    try {
      const res = await fetch('/api/automation/manual-process', {
        method: 'POST',
        headers: {'content-type':'application/json'},
        body: JSON.stringify({ filename })
      });
      
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || 'Erreur lors du traitement');

      statusEl.textContent = "Succès ! Le téléchargement va commencer.";
      
      // Trigger automatic download
      window.location.href = data.download_url;
      
    } catch (err) {
      statusEl.textContent = "Erreur: " + err.message;
      statusEl.style.color = "red";
    } finally {
      btnAutomation.disabled = false;
      btnAutomation.textContent = "Générer et insérer QR code";
    }
  });
  </script>
</body>
</html>
